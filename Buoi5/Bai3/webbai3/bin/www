#!/usr/bin/env node

/**
 * Module dependencies.
 */

var app = require('../app');
var debug = require('debug')('webbai3:server');
var http = require('http');

// NHá»®NG DÃ’NG Má»šI ÄÆ¯á»¢C THÃŠM VÃ€O CHO CHá»¨C NÄ‚NG IOT
const { SerialPort } = require('serialport');
const { ReadlineParser } = require('@serialport/parser-readline');
const WebSocket = require('ws');


/**
 * Get port from environment and store in Express.
 */

var port = normalizePort(process.env.PORT || '4000');
app.set('port', port);

/**
 * Create HTTP server.
 */

var server = http.createServer(app);

// NHá»®NG DÃ’NG Má»šI ÄÆ¯á»¢C THÃŠM VÃ€O CHO CHá»¨C NÄ‚NG IOT
// Khá»Ÿi táº¡o WebSocket Server vÃ  gáº¯n vÃ o HTTP Server hiá»‡n táº¡i
const wss = new WebSocket.Server({ server });

// 1. Cáº¥u hÃ¬nh Serial Port

const SERIAL_PORT_NAME = 'COM2'; 
const BAUD_RATE = 9600; 

const serialPort = new SerialPort({ 
    path: SERIAL_PORT_NAME, 
    baudRate: BAUD_RATE,
    autoOpen: false 
});
// ...

serialPort.open(function (err) {
    if (err) {
        console.error(`Lá»—i má»Ÿ Serial Port ${SERIAL_PORT_NAME}:`, err.message);
        console.error('Kiá»ƒm tra cá»•ng COM áº£o vÃ  mÃ´ phá»ng Proteus.');
        return;
    }
    console.log(`âœ… Serial Port ${SERIAL_PORT_NAME} Ä‘Ã£ má»Ÿ thÃ nh cÃ´ng.`);
});

// Sá»­ dá»¥ng parser Ä‘á»ƒ chia gÃ³i tin báº±ng kÃ½ tá»± xuá»‘ng dÃ²ng (\n)
const parser = serialPort.pipe(new ReadlineParser({ delimiter: '\n' })); 

parser.on('data', data => {
    // Dá»¯ liá»‡u nháº­n Ä‘Æ°á»£c lÃ  chuá»—i JSON: {"temp":25,"hum":60}
    const cleanedData = data.trim(); 
    
    try {
        JSON.parse(cleanedData); // Kiá»ƒm tra xem cÃ³ pháº£i JSON há»£p lá»‡ khÃ´ng

        // Gá»­i dá»¯ liá»‡u real-time qua WebSocket Ä‘áº¿n táº¥t cáº£ clients
        wss.clients.forEach(function each(client) {
            if (client.readyState === WebSocket.OPEN) {
                client.send(cleanedData);
            }
        });

    } catch (e) {
        // Bá» qua cÃ¡c dÃ²ng khÃ´ng pháº£i JSON (vÃ­ dá»¥: thÃ´ng bÃ¡o debug)
        // console.warn('Dá»¯ liá»‡u Serial khÃ´ng pháº£i JSON há»£p lá»‡:', data);
    }
});

wss.on('connection', function connection(ws) {
    console.log('ğŸŒ Má»™t WebApp Client Ä‘Ã£ káº¿t ná»‘i qua WebSocket.');
});



/**
 * Listen on provided port, on all network interfaces.
 */

server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
  var port = parseInt(val, 10);

  if (isNaN(port)) {
    // named pipe
    return val;
  }

  if (port >= 0) {
    // port number
    return port;
  }

  return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
  if (error.syscall !== 'listen') {
    throw error;
  }

  var bind = typeof port === 'string'
    ? 'Pipe ' + port
    : 'Port ' + port;

  // handle specific listen errors with friendly messages
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' requires elevated privileges');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' is already in use');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
  var addr = server.address();
  var bind = typeof addr === 'string'
    ? 'pipe ' + addr
    : 'port ' + addr.port;
  debug('Listening on ' + bind);
  
  // DÃ²ng nÃ y thÃªm cho viá»‡c debugging IoT, xÃ¡c nháº­n má»i thá»© OK
  console.log(`ğŸš€ Server Express vÃ  WebSocket Ä‘ang cháº¡y trÃªn cá»•ng ${addr.port}`); 
}